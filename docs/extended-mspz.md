# Extended MSPZ の仕様

**Extended MSPZ** は、標準的なMSPZ形式（`123m456p...`）を拡張し、副露（鳴き）や暗槓を含む手牌構造を単一の文字列で表現するための独自仕様です。

主にテストデータの作成や、デバッグ時の手牌表現を簡潔に記述するために使用されます。

## 基本構文

拡張MSPZ文字列は、以下の3つの要素の組み合わせで構成されます。

1.  **純手牌 (Closed Tiles)**: 通常のMSPZ形式
2.  **副露 (Open Meld)**: `[...]` (角括弧) で囲む
3.  **暗槓 (Closed Quad)**: `(...)` (丸括弧) で囲む

### 1. 純手牌 (Closed Tiles)

通常のMSPZと同様に、数字とサフィックス（`m`, `p`, `s`, `z`）で表現します。

-   例: `123m456p789s11z`
-   **意味**: 萬子の123、筒子の456、索子の789、字牌の東対子を持つ門前手牌。

### 2. 副露 (Open Meld) - `[...]`

副露（チー、ポン、大明槓）は、構成する牌を角括弧 `[]` で囲んで表現します。  
面子の種類（順子、刻子、槓子）は、牌の構成から自動的に判定されます。

#### チー (Shuntsu)
連続する3枚の牌を記述します。

-   例: `[123m]`
-   **意味**: 萬子の1-2-3のチー（明順子）。

#### ポン (Koutsu)
同一の3枚の牌を記述します。

-   例: `[888p]`
-   **意味**: 筒子の8-8-8のポン（明刻子）。

#### 大明槓 (Daiminkan)
同一の4枚の牌を記述します。

-   例: `[2222s]`
-   **意味**: 索子の2-2-2-2の大明槓（明槓子）。

### 3. 暗槓 (Closed Quad) - `(...)`

暗槓は、構成する4枚の牌を丸括弧 `(...)` で囲んで表現します。  
暗槓は手牌構成上は「副露（Exposed）」の一部として扱われることが多いですが、機能的には「門前（Closed）」の性質も持ちます。

-   例: `(1111z)`
-   **意味**: 字牌の東の暗槓。

## 複合例

複数の要素を組み合わせて記述できます。  
順序は問いませんが、可読性のために純手牌を先に、副露を後ろに記述することを推奨します。

-   **例1 (タンヤオ)**:
    `22m33p44s[555m][666p]`
    -   純手牌: 22m, 33p, 44s
    -   副露: 555m (ポン), 666p (ポン)

-   **例2 (暗槓を含む)**:
    `19m19p19s1234567z(8888s)`
    -   純手牌: 19m, 19p, 19s, 1234567z
    -   暗槓: 8888s

## 制約事項

-   **サフィックスの必須化**: 各ブロック（`[]` や `()` の中身も含む）内で、少なくとも1つのサフィックスが必要です。
    -   OK: `[123m]`
    -   NG: `[123]` (サフィックスがないため不正)
-   **牌の枚数**:
    -   Shuntsu (チー): 正確に3枚かつ連続していること。
    -   Koutsu (ポン): 正確に3枚かつ同一であること。
    -   Kantsu (カン): 正確に4枚かつ同一であること。
-   **赤ドラ**: 現時点では赤ドラ（`0m`など）の扱いは明示的に定義されていませんが、通常のMSPZと同様に扱われることを想定しています。

## API

本ライブラリは、MSPZ形式の文字列を手牌オブジェクトに変換するための関数を公開しています。

### `parseMspzToTehai(input: string): Tehai`

標準的なMSPZ文字列（例: `"123m456p..."`）を解析して `Tehai` オブジェクトを返します。  
副露牌は含まれず、全ての牌は `closed` プロパティに格納されます。

### `parseExtendedMspzToTehai(input: string): Tehai`

拡張MSPZ文字列（例: `"123m[456p]..."`）を解析して `Tehai` オブジェクトを返します。  
`[...]` や `(...)` で囲まれた部分は `exposed` プロパティ（副露）として格納されます。

### `isExtendedMspz(input: string): boolean`

文字列が拡張MSPZ形式を含んでいるか（`[` または `(` を含むか）を判定します。

---

使用例:

```typescript
import { parseExtendedMspzToTehai } from "riichi-mahjong";

const tehai = parseExtendedMspzToTehai("123m[456p]");
// tehai.closed: [1m, 2m, 3m]
// tehai.exposed: [ { type: "Koutsu", hais: [4p, 4p, 4p], ... } ]
```

### 鳴き元のデフォルト (Default Tacha)

拡張MSPZ形式では、鳴き元（誰から鳴いたか）を現時点では指定できません。  
そのため、パーサーは以下のデフォルト値を適用します。

-   **チー**: `Kamicha` (上家)
-   **ポン**: `Toimen` (対面)
-   **大明槓**: `Toimen` (対面)

厳密な鳴き元の指定が必要なテストケースでは、`createTehai` ではなく個別にオブジェクトを構築するか、将来的に記法を拡張する必要があります。
